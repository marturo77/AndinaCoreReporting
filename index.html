<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Pruebas Automatizadas ‚Äì Andina Vida Seguros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Hist√≥rico de reportes de pruebas automatizadas Allure ‚Äì Andina Vida Seguros" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="styles.css" />

</head>

<body>
  <header>
    <div class="header-inner">
      <div class="brand-block">
        <div class="logo-circle">
          AV
        </div>
        <div class="brand-text">
          <h1>
            <span class="main">Andina Vida Seguros</span>
            <span class="sub">CORE Andina ¬∑ UAT</span>
          </h1>
          <p>Dashboard de reportes de pruebas automatizadas (Allure)</p>
        </div>
      </div>
      <div class="header-badge">
        <div class="chip-env">
          <span class="chip-env-dot"></span>
          <span>Pipeline de pruebas activo</span>
        </div>
        <span class="subtext">√öltimo despliegue publicado v√≠a GitHub Actions.</span>
      </div>
    </div>
  </header>

  <main>
    <div class="grid-layout">
      <!-- Panel: √öltimo reporte -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="pill-label">Visi√≥n general</div>
              <h2>
                √öltimo reporte publicado
                <span class="pill-latest">LATEST</span>
              </h2>
              <p id="latest-subtitle">
                Cargando informaci√≥n del √∫ltimo build‚Ä¶
              </p>
            </div>
          </div>

          <div class="latest-body" id="latest-body">
            <!-- Aqu√≠ se renderiza el √∫ltimo reporte -->
          </div>

          <div class="status-bar">
            <span id="status-label" class="muted">
              Esperando datos de <code>reports.json</code>‚Ä¶
            </span>
            <span id="status-count" class="muted"></span>
          </div>
        </div>
      </section>

      <!-- Panel: Hist√≥rico -->
      <section class="card">
        <div class="card-inner">
          <div class="panel-right-header">
            <div>
              <div class="pill-label">Hist√≥rico</div>
              <h2>Todos los reportes ejecutados</h2>
              <span id="history-subtitle" class="count">
                Cargando historial‚Ä¶
              </span>
            </div>
          </div>

          <div class="search-box">
            <div class="search-input-wrapper">
              <span class="search-icon">üîç</span>
              <input id="search-input" class="search-input" type="text" placeholder="Filtrar por fecha (Colombia) o id‚Ä¶"
                autocomplete="off" />
            </div>
          </div>

          <div class="table-wrapper" id="table-wrapper" style="display:none;">
            <table>
              <thead>
                <tr>
                  <th>Reportes (hora local Colombia)</th>
                </tr>
              </thead>
              <tbody id="reports-tbody">
                <!-- Filas din√°micas -->
              </tbody>
            </table>
          </div>

          <div id="no-results" class="no-results" style="display:none;">
            No hay resultados que coincidan con el filtro aplicado.
          </div>

          <div id="history-message" class="status-message-muted"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const latestBodyEl = document.getElementById("latest-body");
    const latestSubtitleEl = document.getElementById("latest-subtitle");
    const statusLabelEl = document.getElementById("status-label");
    const statusCountEl = document.getElementById("status-count");
    const historySubtitleEl = document.getElementById("history-subtitle");
    const historyMessageEl = document.getElementById("history-message");
    const tableWrapperEl = document.getElementById("table-wrapper");
    const tbodyEl = document.getElementById("reports-tbody");
    const noResultsEl = document.getElementById("no-results");
    const searchInputEl = document.getElementById("search-input");

    let reports = [];
    let filteredReports = [];

    // Formateador fijo a zona horaria de Colombia
    const colombiaFormatter = new Intl.DateTimeFormat("es-CO", {
      timeZone: "America/Bogota",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });

    function parseAsUtcDate(isoString) {
      if (!isoString) return null;

      // Si ya tiene zona horaria (Z o +/-hh:mm), la respetamos
      if (/[zZ]$/.test(isoString) || /[+\-]\d\d:\d\d$/.test(isoString)) {
        return new Date(isoString);
      }

      // Si no tiene zona horaria, asumimos UTC
      return new Date(isoString + "Z");
    }

    function formatDateLabel(report) {
      if (report.createdAt) {
        try {
          const d = parseAsUtcDate(report.createdAt);
          return colombiaFormatter.format(d); // UTC -> hora Colombia
        } catch (e) {
          console.error("Error formateando fecha:", e);
        }
      }
      // fallback
      return report.id || "(sin id)";
    }

    function renderLatest() {
      latestBodyEl.innerHTML = "";

      if (!reports.length) {
        latestSubtitleEl.textContent = "A√∫n no hay reportes registrados.";
        statusLabelEl.textContent = "Sin datos de pruebas automatizadas.";
        return;
      }

      const latest = reports[0]; // ya viene ordenado del JSON
      const dateLabel = formatDateLabel(latest);

      latestSubtitleEl.textContent = `Build m√°s reciente publicado: ${dateLabel}`;

      const wrapper = document.createElement("div");

      wrapper.innerHTML = `        
        <div class="latest-meta">
          <span class="badge">
            <strong>Fecha (Colombia):</strong> ${dateLabel}
          </span>
        </div>
        <div class="latest-actions">
          <a href="${latest.url}" target="_blank" class="btn-primary">
            Ver √∫ltimo reporte
            <span class="icon-arrow">‚Üó</span>
          </a>
        </div>
        <p class="hint">
          Las fechas se muestran en hora de Colombia (America/Bogota), asumiendo que los datos del pipeline est√°n en UTC.
        </p>
      `;

      latestBodyEl.appendChild(wrapper);
      statusLabelEl.textContent = "Datos cargados correctamente desde reports.json.";
    }

    function renderTable() {
      tbodyEl.innerHTML = "";

      if (!filteredReports.length) {
        tableWrapperEl.style.display = "none";
        noResultsEl.style.display = "block";
        historyMessageEl.textContent =
          "Ajusta el filtro o ejecuta nuevamente el pipeline de pruebas para generar m√°s reportes.";
        return;
      }

      tableWrapperEl.style.display = "block";
      noResultsEl.style.display = "none";

      filteredReports.forEach((r) => {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        const a = document.createElement("a");

        const label = formatDateLabel(r); // hora local
        a.innerHTML = `<span class="folder-icon">üìÅ</span>${label}`;
        a.href = r.url || "#";
        a.target = "_blank";
        a.className = "link-table";
        a.title = r.folder || r.id || "";

        td.appendChild(a);
        tr.appendChild(td);
        tbodyEl.appendChild(tr);
      });

      historyMessageEl.textContent =
        "Listado ordenado por fecha de creaci√≥n (m√°s reciente primero).";
    }

    function applyFilter() {
      const term = searchInputEl.value.trim().toLowerCase();
      if (!term) {
        filteredReports = [...reports];
      } else {
        filteredReports = reports.filter((r) => {
          const haystack = [
            r.id || "",
            r.folder || "",
            formatDateLabel(r)
          ]
            .join(" ")
            .toLowerCase();
          return haystack.includes(term);
        });
      }

      renderTable();

      if (filteredReports.length && term) {
        historySubtitleEl.textContent = `Mostrando ${filteredReports.length} reporte(s) filtrados.`;
      } else if (reports.length) {
        historySubtitleEl.textContent = `Total: ${reports.length} reporte(s) almacenados.`;
      }
    }

    async function loadReports() {
      try {
        statusLabelEl.textContent = "Cargando datos de reports.json‚Ä¶";
        statusCountEl.textContent = "";
        historySubtitleEl.textContent = "Cargando historial‚Ä¶";

        const res = await fetch("reports.json", { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();
        if (!Array.isArray(data)) {
          throw new Error("Formato inv√°lido: se esperaba un arreglo.");
        }

        reports = data;
        filteredReports = [...reports];

        if (!reports.length) {
          latestSubtitleEl.textContent = "A√∫n no se ha publicado ning√∫n reporte.";
          statusLabelEl.textContent = "Sin datos de ejecuci√≥n de pruebas.";
          historySubtitleEl.textContent = "Hist√≥rico vac√≠o.";
          historyMessageEl.textContent =
            "Cuando el pipeline publique su primer reporte, aparecer√° autom√°ticamente en este panel.";
          return;
        }

        statusCountEl.textContent = `Total de reportes: ${reports.length}`;
        historySubtitleEl.textContent = `Total: ${reports.length} reporte(s) almacenados.`;

        renderLatest();
        renderTable();
      } catch (err) {
        console.error(err);
        statusLabelEl.textContent = "No se pudo leer reports.json.";
        statusLabelEl.classList.add("status-pill-error");
        historySubtitleEl.textContent = "Error al cargar el historial.";
        historyMessageEl.textContent =
          "Verifica que reports.json exista en la ra√≠z del repositorio p√∫blico y que tenga un formato v√°lido.";
      }
    }

    searchInputEl.addEventListener("input", () => {
      applyFilter();
    });

    window.addEventListener("load", () => {
      loadReports();
    });
  </script>
</body>

</html>